@using InvoiceCreator_BlazorFrontend.Components.Userverwaltung.Services
@using Shared.Domain.Models

@inject UserService Service
@inject NavigationManager Navigation
@inherits BasePage
@rendermode InteractiveServer

@page "/users"

<PaginatedListPage TItem="User"
                   Titel="Userübersicht"
                   Items="@Users"
                   AktuelleSeite="@AktuelleSeite"
                   EintraegeProSeite="@EintraegeProSeite"
                   EintraegeAuswahl="@EintraegeAuswahl"
                   IsBusy="@IsBusy"
                   IstVorherigeDeaktiviert="IstVorherigeDeaktiviert"
                   IstNaechsteDeaktiviert="IstNaechsteDeaktiviert"
                   OnSeiteGewechselt="SeiteGewechselt"
                   SeitenGesamt="SeitenGesamt"
                   OnEintraegeProSeiteGeaendert="EintraegeGeaendert"
                   Suchbegriff="@SuchBegriff"
                   OnSuchbegriffGeaendert="SuchbegriffGeaendert"
                   OnNeuFormular="@NavigiereZuNeuFormular">

    <ChildContentHeader>
        <tr>
            <th>User</th>
            <th>Rolle</th>
            <th>Zuletzt eingeloggt</th>
        </tr>
    </ChildContentHeader>
    <ChildContentRow Context="user">
        <tr @onclick="() => NavigiereZuDetails(user.Id)" style="cursor:pointer;">
            <td>@user.UserName</td>
            <td>@user.Rolle.ToString()</td>
            <td>@user.LetzterLogin</td>
            <td>
                <button class="btn btn-sm btn-outline-danger" @onclick:stopPropagation="true" @onclick="() => DeleteAsync(user.Id)">Löschen</button>
                <button class="btn btn-sm btn-outline-secondary" @onclick:stopPropagation="true" @onclick="() => NavigiereZuEditAsync(user.Id)">Bearbeiten</button>
            </td>
        </tr>
    </ChildContentRow>
</PaginatedListPage>





@code {
    private List<User> Users = new();
    private string? SuchBegriff { get; set; } = string.Empty;
    private int AktuelleSeite = 1;
    private int SeitenGesamt { get; set; }
    private int EintraegeProSeite = 10;
    private List<int> EintraegeAuswahl = new() { 5, 10, 25, 50 };
    private bool IstVorherigeDeaktiviert => AktuelleSeite <= 1;
    private bool IstNaechsteDeaktiviert => Users.Count < EintraegeProSeite;


    protected override async Task OnInitializedAsync()
    {
        await LadeDatenAsync();
    }

    private async Task LadeDatenAsync()
    {
        await TryCatchAsync(async () =>
        {
            var result = await Service.GetPagedUsersAsync(SuchBegriff, AktuelleSeite, EintraegeProSeite);
            Users = result.DtoListe.ToList();
            EintraegeProSeite = result.ElementeProSeite;
            SeitenGesamt = result.GesamtAnzahl;
        });
    }
    private async Task SeiteGewechselt(int neueSeite)
    {
        AktuelleSeite = neueSeite;
        await LadeDatenAsync();
    }

    private async Task EintraegeGeaendert(int neueAnzahl)
    {
        EintraegeProSeite = neueAnzahl;
        AktuelleSeite = 1;
        await LadeDatenAsync();
    }

    private async Task SuchbegriffGeaendert(string begriff)
    {
        SuchBegriff = begriff;
        await LadeDatenAsync();
    }

    private void NavigiereZuNeuFormular() =>
        Navigation.NavigateTo("user/form");

    private void NavigiereZuDetails(string id) =>
        Navigation.NavigateTo($"/user/details/{id}");

    private void NavigiereZuEditAsync(string id) =>
        Navigation.NavigateTo($"/user/form/{id}");

    private async Task DeleteAsync(string id)
    {
        await TryCatchAsync(async () =>
        {
            var result = await Service.DeleteUserAsync(id);
            Users.RemoveAll(k => k.Id == id);
        });
        await LadeDatenAsync();
    }
}
